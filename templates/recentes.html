{% extends "base.html" %}
{% block content %}

<div class="panel">
  <div class="panel-head">
    <h1 class="panel-title">Propostas recentes</h1>
    <p class="panel-subtitle">Últimos 10 dias. Você pode visualizar, baixar, emitir contrato e excluir.</p>
  </div>

  <div class="panel-body">
    {% if not items %}
      <div class="empty">Nenhuma proposta ainda.</div>
    {% else %}
      <div class="list">
        {% for p in items %}
          <div class="item">
            <div class="item-title">#{{ p.id }} — {{ p.client_name }}</div>
            <div class="item-sub">
              Criada: {{ p.created_at.strftime('%d/%m/%Y %H:%M') }} |
              Expira: {{ p.expires_at.strftime('%d/%m/%Y %H:%M') }}
            </div>

            <div class="actions">
              <button class="btn" type="button" onclick="verProposta({{ p.id }})">Visualizar</button>
              <a class="btn" href="{{ url_for('baixar_proposta', proposal_id=p.id) }}">Baixar PDF</a>
              <a class="btn" href="{{ url_for('contrato', proposal_id=p.id) }}">Emitir contrato</a>

              <form method="post" action="{{ url_for('excluir_proposta', proposal_id=p.id) }}" style="display:inline;">
                <button class="btn danger" type="submit" onclick="return confirm('Excluir esta proposta?')">Excluir</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="actions">
      <a class="btn" href="/gerador">Voltar</a>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-card">
    <div class="modal-title">Dados da proposta</div>
    <pre id="modalPre" class="modal-pre"></pre>
    <div class="actions">
      <button class="btn" type="button" onclick="fecharModal()">Fechar</button>
    </div>
  </div>
</div>

<script>
  async function verProposta(id){
    try{
      const r = await fetch(`/api/proposta/${id}`);
      if(!r.ok) throw new Error("Erro ao carregar proposta.");
      const data = await r.json();
      document.getElementById("modalPre").textContent = JSON.stringify(data, null, 2);
      document.getElementById("modal").style.display = "flex";
    }catch(e){
      alert(e.message || "Erro ao carregar proposta.");
    }
  }
  function fecharModal(){
    document.getElementById("modal").style.display = "none";
  }
</script>

{% endblock %}