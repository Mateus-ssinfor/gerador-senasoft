{% extends "base.html" %}
{% block content %}

<div class="card" style="text-align:left;">
  <h2 style="margin:0 0 6px;">Propostas recentes</h2>
  <p style="margin:0 0 14px; opacity:.75;">Últimos 10 dias. Você pode visualizar, baixar, emitir contrato e excluir.</p>

  {% if not items %}
    <div class="empty">Nenhuma proposta ainda.</div>
  {% else %}
    <div class="list" style="display:flex; flex-direction:column; gap:12px;">
      {% for p in items %}
        <div class="card" style="padding:14px;">
          <div style="font-weight:800; margin-bottom:6px;">#{{ p.id }} — {{ p.client_name }}</div>
          <div style="opacity:.8; font-size:13px; margin-bottom:10px;">
            Criada: {{ p.created_at.strftime('%d/%m/%Y %H:%M') }} |
            Expira: {{ p.expires_at.strftime('%d/%m/%Y %H:%M') }}
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" type="button" onclick="verProposta({{ p.id }})">Visualizar</button>
            <a class="btn" href="{{ url_for('baixar_proposta', proposal_id=p.id) }}">Baixar PDF</a>
            <a class="btn" href="{{ url_for('contrato', proposal_id=p.id) }}">Emitir contrato</a>

            <form method="post" action="{{ url_for('excluir_proposta', proposal_id=p.id) }}" style="display:inline;">
              <button class="btn danger" type="submit" onclick="return confirm('Excluir esta proposta?')">Excluir</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div style="display:flex; gap:10px; margin-top:14px;">
    <a class="btn" href="/gerador" style="justify-content:center; flex:1;">Voltar</a>
  </div>
</div>

<style>
  #modalOverlay{
    position: fixed; inset:0; display:none; align-items:center; justify-content:center;
    padding:18px; background: rgba(0,0,0,.65); backdrop-filter: blur(6px); z-index:9999;
  }
  #modalCard{
    width:min(560px, 95vw);
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(20,20,20,.92);
    box-shadow: 0 20px 60px rgba(0,0,0,.55);
    padding:16px;
  }
  .kv{
    display:flex; justify-content:space-between; gap:12px;
    padding:10px 12px; border-radius:12px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
    margin-top:10px;
  }
  .k{ opacity:.75; font-size:13px; }
  .v{ font-weight:700; text-align:right; }
</style>

<div id="modalOverlay" onclick="fecharModal(event)">
  <div id="modalCard" onclick="event.stopPropagation()">
    <div style="font-weight:900; margin:0 0 6px; font-size:16px;">Dados da proposta</div>

    <div class="kv"><div class="k">Cliente</div><div class="v" id="mCliente"></div></div>
    <div class="kv"><div class="k">CPF</div><div class="v" id="mCpf"></div></div>
    <div class="kv"><div class="k">Modelo</div><div class="v" id="mModelo"></div></div>
    <div class="kv"><div class="k">Franquia</div><div class="v" id="mFranquia"></div></div>
    <div class="kv"><div class="k">Valor</div><div class="v" id="mValor"></div></div>
    <div class="kv"><div class="k">Criada</div><div class="v" id="mCriada"></div></div>
    <div class="kv"><div class="k">Expira</div><div class="v" id="mExpira"></div></div>

    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button class="btn" type="button" onclick="fecharModal()">Fechar</button>
    </div>
  </div>
</div>

<script>
  async function verProposta(id){
    try{
      const r = await fetch(`/api/proposta/${id}`);
      if(!r.ok) throw new Error("Erro ao carregar proposta.");
      const d = await r.json();

      document.getElementById("mCliente").textContent = d.client_name || "";
      document.getElementById("mCpf").textContent     = d.cpf || "";
      document.getElementById("mModelo").textContent  = d.modelo || "";
      document.getElementById("mFranquia").textContent= d.franquia || "";
      document.getElementById("mValor").textContent   = d.valor || "";
      document.getElementById("mCriada").textContent  = d.criada || "";
      document.getElementById("mExpira").textContent  = d.expira || "";

      document.getElementById("modalOverlay").style.display = "flex";
    }catch(e){
      alert(e.message || "Erro ao carregar proposta.");
    }
  }

  function fecharModal(){
    document.getElementById("modalOverlay").style.display = "none";
  }
</script>

{% endblock %}